function handleCalDAVError(e,l){var o="";o=globalResourceCalDAVList.collections;for(var t=0;t<o.length;t++)if(null!=o[t].uid){var i=(C=o[t].accountUID.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@([^/]+)(.*/)","i")))[1]+C[3]+C[4],a=C[2];if(l.href==i&&l.userAuth.userName==a){if("event"==globalSettingsSaving&&e){var r=!1;if("undefined"!=typeof globalCrossServerSettingsURL&&null!=globalCrossServerSettingsURL&globalCrossServerSettingsURL){for(var s=(p=o[t].uid.match(RegExp("/([^/]+/[^/]+/)$")))[1].match("^(.*/)([^/]+)/$"),n=decodeURIComponent(s[1])+s[2]+"/",d=!1,c=0;c<globalSettings.loadedcalendarcollections.value.length;c++){var u=globalSettings.loadedcalendarcollections.value[c].match("^(.*/)([^/]+)/([^/]+)/$");if(n==decodeURIComponent(u[2])+"/"+u[3]+"/"){d=!0;break}}r=d}else{n=(p=o[t].uid.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@(.*)")))[1]+p[3];r=-1!=globalSettings.loadedcalendarcollections.value.indexOf(n)}if(r&&""==o[t].oldSyncToken){var h=$.extend(o[t],{makeLoaded:!0});globalResourceCalDAVList.insertResource(h,o[t].resourceIndex,!0),updateMainLoaderText(o[t].listType),updateMainLoader()}}e?$("#ResourceCalDAVList").find('[data-id="'+o[t].uid+'"]').addClass("r_error"):$("#ResourceCalDAVList").find('[data-id="'+o[t].uid+'"]').removeClass("r_error")}}o=globalResourceCalDAVList.TodoCollections;for(t=0;t<o.length;t++)if(null!=o[t].uid){var C;i=(C=o[t].accountUID.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@([^/]+)(.*/)","i")))[1]+C[3]+C[4],a=C[2];if(l.href==i&&l.userAuth.userName==a){if("todo"==globalSettingsSaving&&e){r=!1;if("undefined"!=typeof globalCrossServerSettingsURL&&null!=globalCrossServerSettingsURL&globalCrossServerSettingsURL){for(s=(p=o[t].uid.match(RegExp("/([^/]+/[^/]+/)$")))[1].match("^(.*/)([^/]+)/$"),n=decodeURIComponent(s[1])+s[2]+"/",d=!1,c=0;c<globalSettings.loadedtodocollections.value.length;c++){u=globalSettings.loadedtodocollections.value[c].match("^(.*/)([^/]+)/([^/]+)/$");if(n==decodeURIComponent(u[2])+"/"+u[3]+"/"){d=!0;break}}r=d}else{var p;n=(p=o[t].uid.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@(.*)")))[1]+p[3];r=-1!=globalSettings.loadedtodocollections.value.indexOf(n)}if(r&&""==o[t].oldSyncToken){h=$.extend(o[t],{makeLoaded:!0});globalResourceCalDAVList.insertResource(h,o[t].resourceIndex,!1),updateMainLoaderText(o[t].listType),updateMainLoader()}}e?$("#ResourceCalDAVTODOList").find('[data-id="'+o[t].uid+'"]').addClass("r_error"):$("#ResourceCalDAVTODOList").find('[data-id="'+o[t].uid+'"]').removeClass("r_error")}}}function unloadCalDAVCollection(e,l){var o={},t="";l?o=globalResourceCalDAVList.collections:(o=globalResourceCalDAVList.TodoCollections,t="TODO");for(var i=0;i<o.length;i++)if(null!=o[i].uid){var a=o[i].uid.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@(.*)")),r=a[1]+a[3];if(-1!=e.indexOf(r)){if($("#CalendarLoader"+t).children(".loaderInfo").text(localization[globalInterfaceLanguage].unloadingCalendars),-1!=window["globalVisibleCalDAV"+t+"Collections"].indexOf(o[i].uid)&&window["globalVisibleCalDAV"+t+"Collections"].splice(window["globalVisibleCalDAV"+t+"Collections"].indexOf(o[i].uid),1),l){var s=$("#main").width()-$("#calendar").width();$("#calendar").fullCalendar("removeEventSource",o[i].fcSource);var n=$("#main").width()-$("#calendar").width();rerenderCalendar(s!=n),globalEventList.events[o[i].uid]={},globalEventList.displayEventsArray[o[i].uid]=new Array}else{s=$("#mainTODO").width()-$("#todoList").width();$("#todoList").fullCalendar("removeEventSource",o[i].fcSource);n=$("#mainTODO").width()-$("#todoList").width();rerenderTodo(s!=n),globalEventList.todos[o[i].uid]={},globalEventList.displayTodosArray[o[i].uid]=new Array}o[i].fcSource=null,o[i].someChanged=!1,o[i].makeLoaded=!1,o[i].syncToken="",o[i].oldSyncToken=""}}"event"!=globalSettingsSaving&&"todo"!=globalSettingsSaving||globalFirstHideLoader||setTimeout(function(){hideUnloadCollectionCallback(globalSettingsSaving)},300)}function addLoadCalDAVCollection(e,l){var o={},t="";l?o=globalResourceCalDAVList.collections:(o=globalResourceCalDAVList.TodoCollections,t="TODO");for(var i=0;i<o.length;i++)if(null!=o[i].uid){var a=o[i].uid.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@(.*)")),r=a[1]+a[3];if(-1!=e.indexOf(r)&&!o[i].makeLoaded){o[i].urlArray={};var s=$("#ResourceCalDAV"+t+"List").find(".resourceCalDAV"+t+'_item[data-id="'+jqueryEscapeSelector(o[i].uid)+'"]');o[i].someChanged=!0,o[i].makeLoaded=!0;for(var n=vCalendar.pre.accountUidParts,d=o[i].accountUID.match(n),c=d[1]+d[3]+d[4],u=d[2],h=0;h<globalAccountSettings.length;h++)if(globalAccountSettings[h].href==c&&globalAccountSettings[h].userAuth.userName==u&&-1==globalLoadedPrincipals.indexOf(c)){globalLoadedPrincipals.push(globalAccountSettings[h].href);break}var C=s.prevUntil(".resourceCalDAV"+t+"_header").last().prev();C.length||(C=s.prev()),C.css("display","block"),s.css("display","");var p=s.find("input[type=checkbox]").not(".unloadCheck");p.prop("checked",!0),collectionChBoxClick(p.get(0),"#ResourceCalDAV"+t+"List",".resourceCalDAV"+t+"_header",".resourceCalDAV"+t+"_item",null,!1),-1==window["globalVisibleCalDAV"+t+"Collections"].indexOf(o[i].uid)&&window["globalVisibleCalDAV"+t+"Collections"].splice(window["globalVisibleCalDAV"+t+"Collections"].length,0,o[i].uid),o[i].newlyAdded=!0}}var g=new Array;for(i=0;i<o.length;i++)null!=o[i].uid&&(g[g.length]={displayValue:o[i].displayvalue,uid:o[i].uid,permissions_read_only:o[i].permissions.read_only,makeLoaded:o[i].makeLoaded});g.sort(customResourceCompare),globalResourceCalDAVList.sortedCollections=g}function ResourceCalDAVList(){this.collections=new Array,this.TodoCollections=new Array,this.calendarsLoaded=null,this.counterList=new Array,this.sortedTodoCollections=new Array,this.sortedCollections=new Array,this.reset=function(){this.TodoCollections.splice(0,this.TodoCollections.length),this.collections.splice(0,this.collections.length),this.counterList=new Array,this.sortedTodoCollections=new Array,this.sortedCollections=new Array},this.getHeaderValue=function(e){var l=new RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@([^/]+).*/([^/]*)/","i"),o=e.accountUID.match(l),t=o[3],i=o[3].replace(vCalendar.pre.numberPortRex,""),a=i.replace(vCalendar.pre.domainRex,""),r=i.match(vCalendar.pre.domainNameRex)[2],s=decodeURIComponent(o[4]),n=decodeURIComponent(o[4]).replace(vCalendar.pre.principalUserNameRex,""),d=e.userAuth.userName,c=e.userAuth.userName.replace(vCalendar.pre.loginRex,"");e.subscription||"string"==typeof e.hrefLabel&&""!=e.hrefLabel&&("%x"!=e.hrefLabel||""!=e.headervalue)?!e.subscription||"string"==typeof e.hrefLabel&&""!=e.hrefLabel||(e.hrefLabel=localization[globalInterfaceLanguage].txtSubscribed):e.hrefLabel="%d/%p [%u]";var u=e.hrefLabel;return u=(u=(u=(u=(u=(u=(u=(u=(u=u.replace(vCalendar.pre.HRex,t)).replace(vCalendar.pre.hRex,i)).replace(vCalendar.pre.DRex,a)).replace(vCalendar.pre.dRex,r)).replace(vCalendar.pre.PRex,s)).replace(vCalendar.pre.pRex,n)).replace(vCalendar.pre.URex,d)).replace(vCalendar.pre.uRex,c)).replace(vCalendar.pre.xRex,e.headervalue),e.hrefLabel=u,u},this.getSortKey=function(e,l,o){var t=new RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@([^/]+)(.*/)([^/]+/)([^/]+/)([^/]*)","i"),i=e.uid.match(t),a="";return a=e.subscription?"B":"A",1!=globalSettings.resourcealphabetsorting.value&&(a+=o.pad(String(globalAccountSettings.length).length)),a+=i[1]+i[3]+"/"+(null==e.hrefLabel||null==e.hrefLabel?i[5]:e.hrefLabel)+" "+e.userAuth.userName,0==l&&(a+=" "+e.displayvalue),a},this.insertResource=function(e,l,o){var t=e.hrefLabel,i=this.getHeaderValue(e);e.sortkey=this.getSortKey(e,!1,l);var a={},r="",s=!1,n=!1;o?a=this.collections:(a=this.TodoCollections,r="TODO");for(var d=0;d<a.length;d++)if(a[d].uid==e.uid){a[d].urlArray={};var c=$("#ResourceCalDAV"+r+"List").find(".resourceCalDAV"+r+'_item[data-id="'+jqueryEscapeSelector(e.uid)+'"]');if(a[d].displayvalue==e.displayvalue&&a[d].permissions.read_only==e.permissions.read_only&&a[d].headervalue==e.headervalue)return a[d]=$.extend(e,{fcSource:a[d].fcSource,syncToken:a[d].syncToken,oldSyncToken:a[d].oldSyncToken,newlyAdded:a[d].newlyAdded,forceSyncPROPFIND:a[d].forceSyncPROPFIND}),0;n=!0,$.extend(e,{fcSource:a[d].fcSource,syncToken:a[d].syncToken,oldSyncToken:a[d].oldSyncToken,newlyAdded:a[d].newlyAdded,forceSyncPROPFIND:a[d].forceSyncPROPFIND}),s=c.find("input[type=checkbox]").not(".unloadCheck").prop("checked"),this.removeResource(e.uid,!1,o);break}if(!globalCalDAVInitLoad&&!n){var u=(p=e.uid.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@(.*)")))[1]+p[3],h=null,C=!1;if(h=o?globalSettings.loadedcalendarcollections.value:globalSettings.loadedtodocollections.value,"undefined"!=typeof globalCrossServerSettingsURL&&null!=globalCrossServerSettingsURL&globalCrossServerSettingsURL){for(var p,g=(p=e.uid.match(RegExp("/([^/]+/[^/]+/)$")))[1].match("^(.*/)([^/]+)/$"),f=decodeURIComponent(g[1])+g[2]+"/",v=!1,b=0;b<h.length;b++){var m=h[b].match("^(.*/)([^/]+)/([^/]+)/$");if(f==decodeURIComponent(m[2])+"/"+m[3]+"/"){v=!0;break}}C=v}else C=-1!=h.indexOf(u);C?(e.makeLoaded=!0,e.newlyAdded=!0):(e.makeLoaded=!1,e.newlyAdded=!1),e.oldSyncToken="",e.someChanged=!1,s=!0}var y={headerOnly:!0,sortkey:this.getSortKey(e,!0,l),displayvalue:"%x"==t?i.replace(RegExp("^[^#]+#"),""):i,index:0},A=0,D=0,L=a.length-1;if(a.length>0)for(;D<L;){A=D+Math.round((L-D)/2);var T=(cmp_str=a[A].sortkey).customCompare(e.sortkey,globalSortAlphabet,1,!1);if(-1==T){if(A+1==a.length-1&&void 0!==a[A+1]&&-1==(cmp_str=a[A+1].sortkey).customCompare(e.sortkey,globalSortAlphabet,1,!1)){A+=2;break}D=++A}else if(1==T){if(-1==(cmp_str=a[A-1].sortkey).customCompare(e.sortkey,globalSortAlphabet,1,!1))break;L=--A}}var R=1;for(d=0;d<a.length;d++)if(1==a[d].headerOnly&&a[d].displayvalue==y.displayvalue){R=0;break}R&&(y.index=A,a.splice(A,0,y)),1==a.length&&globalCalDAVInitLoad&&$("#SystemCalDavZAP .fc-header-center ").addClass("r_operate_all"),this.counterList[e.uid+" "+e.listType]={collectionLength:0,counter:0,uid:e.uid,isLoading:!1,isSaving:!1},a.splice(A+R,0,e),n||(o?(globalEventList.displayEventsArray[e.uid]=new Array,globalEventList.events[e.uid]={}):(globalEventList.displayTodosArray[e.uid]=new Array,globalEventList.todos[e.uid]={}));var V=".resourceCalDAV"+r+"_header",S=".resourceCalDAV"+r+"_item";R&&((k=$("#ResourceCalDAV"+r+"ListTemplate").find(".resourceCalDAV"+r+"_header").clone().wrap("<div>")).append(y.displayvalue),""==r?k.find("input[type=checkbox]").attr("onclick","resourceChBoxClick(this, '#'+$(this).parent().parent().attr('id'), '"+V+"', false);if(isCalDAVLoaded && $(this).parent().parent().attr('id')== 'ResourceCalDAV"+r+"List'){$(this).prop('checked')?enableResource($(this).parent()):disableResource($(this).parent());}"):k.find("input[type=checkbox]").attr("onclick","resourceChBoxClick(this, '#'+$(this).parent().parent().attr('id'), '"+V+"', false);if(isCalDAVLoaded && $(this).parent().parent().attr('id')== 'ResourceCalDAV"+r+"List'){$(this).prop('checked')?enableResourceTodo($(this).parent()):disableResourceTodo($(this).parent());}"),k.css("display","none"),k=k.parent().html(),$("#ResourceCalDAV"+r+"List").children().eq(A).after(k));var k=$("#ResourceCalDAV"+r+"ListTemplate").find(".resourceCalDAV"+r+"_item").clone().wrap("<div>");e.uid.split("/");if(e.permissions.read_only&&k.addClass("resourceCalDAV_item_ro"),k.attr("data-id",e.uid),globalCalDAVInitLoad&&k.addClass("r_operate"),k.html("<div class='resourceCalDAVColor' style='background:"+e.ecolor+"'></div><input type='text' class='colorPicker'/><input type='checkbox' name="+e.uid+" />"+$("<div/>").text(e.displayvalue).html()),k.attr("title",$("<div/>").text(e.displayvalue).html()),""==r?k.find("input[type=checkbox]").attr({"data-id":e.uid,onclick:"var evt = arguments[0];evt.stopPropagation();collectionChBoxClick(this, '#'+$(this).parent().parent().attr('id'), '"+V+"', '"+S+"', null, false);if(isCalDAVLoaded && $(this).parent().parent().attr('id')== 'ResourceCalDAV"+r+"List'){$(this).prop('checked')?enableCalendar('"+e.uid+"'):disableCalendar('"+e.uid+"');}"}):k.find("input[type=checkbox]").attr({"data-id":e.uid,onclick:"var evt = arguments[0];evt.stopPropagation();collectionChBoxClick(this, '#'+$(this).parent().parent().attr('id'), '"+V+"', '"+S+"', null, false);if(isCalDAVLoaded && $(this).parent().parent().attr('id')== 'ResourceCalDAV"+r+"List'){$(this).prop('checked')?enableCalendarTodo('"+e.uid+"'):disableCalendarTodo('"+e.uid+"');}"}),k.click(function(e){if($(this).hasClass("resourceCalDAV_item")&&globalEventCollectionsLoading||$(this).hasClass("resourceCalDAVTODO_item")&&globalTodoCollectionsLoading)return!0;e.shiftKey&&(o?enableOne($(this).attr("data-id")):enableOneTodo($(this).attr("data-id"))),$("#ResourceCalDAV"+r+"List .resourceCalDAV_item_selected").removeClass("resourceCalDAV_item_selected"),$(this).addClass("resourceCalDAV_item_selected")}),"undefined"!=typeof globalCalendarColorPropertyXmlns&&null!=globalCalendarColorPropertyXmlns&&""!==globalCalendarColorPropertyXmlns&&!1===globalCalendarColorPropertyXmlns||bindColorPickerClick(k.find(".resourceCalDAVColor")),$("#ResourceCalDAV"+r+"List").children().eq(A+R).after(k),e.makeLoaded){var x=k.prevUntil(".resourceCalDAV"+r+"_header").last().prev();x.length||(x=k.prev()),x.css("display","block");var O=vCalendar.pre.accountUidParts,w=e.accountUID.match(O),_=w[1]+w[3]+w[4],E=w[2];for(d=0;d<globalAccountSettings.length;d++)if(globalAccountSettings[d].href==_&&globalAccountSettings[d].userAuth.userName==E&&-1==globalLoadedPrincipals.indexOf(_)){globalLoadedPrincipals.push(globalAccountSettings[d].href);break}}else k.css("display","none");s&&(-1==window["globalVisibleCalDAV"+r+"Collections"].indexOf(e.uid)&&window["globalVisibleCalDAV"+r+"Collections"].splice(window["globalVisibleCalDAV"+r+"Collections"].length,0,e.uid),$("#ResourceCalDAV"+r+"List").children().eq(A+R+1).find("input[type=checkbox]").prop("checked",!0)),globalCalDAVInitLoad||collectionChBoxClick(k.find("input[type=checkbox]").get(0),"#ResourceCalDAV"+r+"List",".resourceCalDAV"+r+"_header",".resourceCalDAV"+r+"_item",null,!1)},this.removeOldResources=function(e,l){e.match(vCalendar.pre.hrefRex)[2];for(var o=this.collections.length-1;o>=0;o--)if(null!=this.collections[o]&&!this.collections[o].subscription&&null!=this.collections[o].timestamp&&0==this.collections[o].uid.indexOf(e)&&this.collections[o].timestamp<l){this.collections[o].uid;var t=$("#main").width()-$("#calendar").width();$("#calendar").fullCalendar("removeEventSource",this.collections[o].fcSource);var i=$("#main").width()-$("#calendar").width();if(rerenderCalendar(t!=i),(d=(n=$("#ResourceCalDAVList").find('.resourceCalDAV_item[data-id^="'+jqueryEscapeSelector(this.collections[o].uid)+'"]')).prevUntil(".resourceCalDAV_header").last().prev()).length||(d=n.prev()),n.remove(),this.collections.splice(o,1),null!=this.collections[o]&&1!=this.collections[o].headerOnly||1!=this.collections[o-1].headerOnly){for(var a=null,r=o-1;r>0&&1!=this.collections[r].headerOnly;r--)if(this.collections[r].makeLoaded){a=this.collections[r];break}if(null==a)for(r=o;r<this.collections.length&&1!=this.collections[r].headerOnly;r++)if(this.collections[r].makeLoaded){a=this.collections[r];break}if(null==a)d.css("display","none");else{var s=$("#ResourceCalDAVList").find('.resourceCalDAV_item[data-id^="'+jqueryEscapeSelector(a.uid)+'"]').find("input[type=checkbox]");collectionChBoxClick(s.get(0),"#ResourceCalDAVList",".resourceCalDAV_header",".resourceCalDAV_item",null,!1)}}else d.remove(),this.collections.splice(--o,1)}for(o=this.TodoCollections.length-1;o>=0;o--)if(null!=this.TodoCollections[o]&&!this.TodoCollections[o].subscription&&null!=this.TodoCollections[o].timestamp&&0==this.TodoCollections[o].uid.indexOf(e)&&this.TodoCollections[o].timestamp<l){this.TodoCollections[o].uid,t=$("#mainTODO").width()-$("#todoList").width();$("#todoList").fullCalendar("removeEventSource",this.TodoCollections[o].fcSource);var n,d;i=$("#mainTODO").width()-$("#todoList").width();if(rerenderTodo(t!=i),(d=(n=$("#ResourceCalDAVTODOList").find('.resourceCalDAVTODO_item[data-id^="'+jqueryEscapeSelector(this.TodoCollections[o].uid)+'"]')).prevUntil(".resourceCalDAVTODO_header").last().prev()).length||(d=n.prev()),n.remove(),this.TodoCollections.splice(o,1),null!=this.TodoCollections[o]&&1!=this.TodoCollections[o].headerOnly||1!=this.TodoCollections[o-1].headerOnly){for(a=null,r=o-1;r>0&&1!=this.TodoCollections[r].headerOnly;r--)if(this.TodoCollections[r].makeLoaded){a=this.TodoCollections[r];break}if(null==a)for(r=o;r<this.TodoCollections.length&&1!=this.TodoCollections[r].headerOnly;r++)if(this.TodoCollections[r].makeLoaded){a=this.TodoCollections[r];break}if(null==a)d.css("display","none");else{s=$("#ResourceCalDAVTODOList").find('.resourceCalDAVTODO_item[data-id^="'+jqueryEscapeSelector(a.uid)+'"]').find("input[type=checkbox]");collectionChBoxClick(s.get(0),"#ResourceCalDAVTODOList",".resourceCalDAVTODO_header",".resourceCalDAVTODO_item",null,!1)}}else d.remove(),this.TodoCollections.splice(--o,1)}},this.removeResource=function(e,l,o){if(o){for(var t=this.collections.length-1;t>=0;t--)if(this.collections[t].uid==e){this.collections[t].uid;var i=(a=$("#ResourceCalDAVList").find('[data-id^="'+jqueryEscapeSelector(this.collections[t].uid)+'"]')).prev();a.remove(),this.collections.splice(t,1),(null==this.collections[t]||1==this.collections[t].headerOnly)&&t>0&&1==this.collections[t-1].headerOnly&&(i.remove(),this.collections.splice(t,1))}}else for(t=this.TodoCollections.length-1;t>=0;t--)if(this.TodoCollections[t].uid==e){var a;this.TodoCollections[t].uid,i=(a=$("#ResourceCalDAVTODOList").find('[data-id^="'+jqueryEscapeSelector(this.TodoCollections[t].uid)+'"]')).prev();a.remove(),this.TodoCollections.splice(t,1),(null==this.TodoCollections[t]||1==this.TodoCollections[t].headerOnly)&&t>0&&1==this.TodoCollections[t-1].headerOnly&&(i.remove(),this.TodoCollections.splice(t,1))}},this.getCollectionByUID=function(e){for(var l=0;l<this.collections.length;l++)if(this.collections[l].uid==e)return this.collections[l];for(l=0;l<this.TodoCollections.length;l++)if(this.TodoCollections[l].uid==e)return this.TodoCollections[l];return null},this.getEventCollectionByUID=function(e){for(var l=0;l<this.collections.length;l++)if(this.collections[l].uid==e)return this.collections[l];return null},this.getTodoCollectionByUID=function(e){for(var l=0;l<this.TodoCollections.length;l++)if(this.TodoCollections[l].uid==e)return this.TodoCollections[l];return null},this.getTodoCollectionAndIndexByUID=function(e){for(var l=0;l<this.TodoCollections.length;l++)if(this.TodoCollections[l].uid==e)return{coll:this.TodoCollections[l],index:l};return null},this.getResources=function(){return this.collections},this.getSyncResourceArray=function(){return this.syncResourceArray}}